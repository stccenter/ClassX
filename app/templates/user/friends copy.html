{% extends 'user/user-base.html' %}
{% block content %}
<div class="friends-all">
    <h1>Friends</h1>
    <p class="friend-desc"> View your list of friends. </p>
    <div class="friends-container">
        <div class="friends-list">
            <h2>Your Friends</h2>
            <select id="filter-friends">
                <option value="all">All Friends</option>
                <!--
                <option value="organization">Friends in Organization</option>
                -->
            </select>
            <button class="add-friend">Add New Friend</button>
            <ul class="friend-list" id="friend-list"></ul>
        </div>

        <div class="modal-all">
            <div class="modal" id="friendsModal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h2>Add Friend</h2>
                    <input type="text" id="searchFriendInput" placeholder="Search for friends by Username...">
                </div>
            </div>
        </div>

        <div class="friend-profile" id="friend-profile">
            <h2>Friend's Profile</h2>
            <div id="profile-details">
                <p>Click on a friend's profile to see more of their information!</p>
                <!--
                <img src="\static\images\profile-image-placeholder.png" alt="Profile Image" class="profile-image">
                <p id="friend-fullname">Full Name: Alice Smith</p>
                <p id="friend-username">Username: @alice</p>
                <button class="remove-friend">Remove Friend</button>
                <button class="share-dataset">Share Datasets</button>
                <button class="view-dataset">View Current Datasets</button>
                -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const friendsList = document.querySelector('.friend-list');
    const friendProfile = document.getElementById('profile-details');
    const addFriendButton = document.querySelector('.add-friend');
    const filterFriends = document.getElementById('filter-friends');
    const modal = document.getElementById('friendsModal');
    const closeButton = document.querySelector('.close-button');
    const searchFriendInput = document.getElementById('searchFriendInput');

    let selectedId = "";

    // Fetch friends and pending requests from backend
    function fetchFriends() {
        const response = fetch('/friends').then((response) => {
            if (response.ok) {
                response.json().then(data => renderFriends(data))
            } else {
                console.error('Error fetching friends');
            }
        });
    }

    function renderFriends(data) {
        console.log(data);
        friendsList.innerHTML = '';
        
        data.forEach((friend) => {
            if(friend?.pending) {
                const li = document.createElement('li');
                li.setAttribute('data-fullname', friend.username); // Update with actual full name if available
                li.innerHTML = `
                    <span class="friend-name">${friend.username}</span>
                    <span class="friend-username">@${friend.username}</span>
                    ${friend.sent ? `
                        <button class="friend-button cancel-request">
                            <i class="fa fa-times"></i>
                        </button>
                    ` : `
                        <button class="friend-button accept-request">
                            <i class="fa fa-check-circle"></i>
                        </button>
                        <button class="friend-button reject-request">
                            <i class="fa fa-times-circle"></i>
                        </button>
                    `}
                `;
                acceptButton = li.querySelector('.accept-request');
                rejectButton = li.querySelector('.reject-request');
                cancelRequestButton = li.querySelector('.cancel-request');

                // register the onclick to handle deny/accept
                acceptButton?.addEventListener('click', () => handleAcceptRequest(friend.uuid));
                rejectButton?.addEventListener('click', () => handleRejectRequest(friend.uuid));
                cancelRequestButton?.addEventListener('click', () => handleRejectRequest(friend.uuid));
                friendsList.appendChild(li);
            }
            else {
                const li = document.createElement('li');
                li.setAttribute('data-fullname', friend.username); // Update with actual full name if available
                li.innerHTML = `
                    <span class="friend-uuid">${friend.username}</span>
                    <span class="friend-username">@${friend.username}</span>
                `;
                friendsList.appendChild(li);
            }
        });

    }

    // when the enter key is pressed and the search input is focused, search for friends
    searchFriendInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSearchInput();
        }
    });

    async function handleAddFriend(username) {
        const response = await fetch('/friends', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        });

        console.log(response);

        if (response.ok) {
            console.log("XD")
            fetchFriends();
        } else {
            console.error('Error adding friend');
        }
    }

    async function handleAcceptRequest(username) {
        const response = await fetch('/friends', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
        });

        if (response.ok) {
            fetchFriends();
        } else {
            console.error('Error accepting friend request');
        }
    }

    async function handleRejectRequest(username) {
        const response = await fetch(`/friends?uuid=${username}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            fetchFriends();
        } else {
            console.error('Error rejecting friend request');
        }
    }

    function openModal() {
        modal.style.display = 'block';
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    function handleSearchInput() {
        const query = searchFriendInput.value.toLowerCase();

        handleAddFriend(searchFriendInput.value ?? "").then(() => {
            searchFriendInput.value = "";
            fetchFriends()
        }).catch(err => console.error(err));

        // Assuming friends are fetched or available
    }

    addFriendButton.addEventListener('click', openModal);
    closeButton.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });


    friendsList.addEventListener('click', (e) => {
        if (e.target.tagName === 'LI' || e.target.closest('li')) {
            const friendItem = e.target.tagName === 'LI' ? e.target : e.target.closest('li');
            const fullName = friendItem.getAttribute('data-fullname');
            const username = friendItem.getAttribute('data-username');
            const uuid = friendItem.getAttribute('data-uuid');

            friendProfile.innerHTML = `
                <p id="friend-fullname">Username: ${fullName}</p>
                <p id="friend-username">UUID: ${username}</p>
                <button class="friend-button remove-friend" data-uuid="${uuid}">Remove Friend</button>
            `;

            // <button class="friend-button share-dataset">Share Datasets</button>
            // <button class="friend-button view-dataset">View Current Datasets</button> 

        }
    });

    friendProfile.addEventListener('click', async (e) => {
        if (e.target.classList.contains('remove-friend')) {
            const uuid = e.target.getAttribute('data-uuid');
            const response = await fetch(`/friends?uuid=${uuid}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                fetchFriends();
            } else {
                console.error('Error removing friend');
            }
        }
    });

    await fetchFriends();
});
</script>
{% endblock %}
